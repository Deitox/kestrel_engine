name: Animation Targets

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  bench:
    name: Animation Target Measurement
    runs-on: windows-latest
    env:
      PERF_SUITE_LABEL: ci_perf_suite
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Configure Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run animation_check on assets
        shell: pwsh
        run: |
          cargo run --bin animation_check -- assets/animations

      - name: Verify atlas schemas (migrate_atlas --check)
        shell: pwsh
        run: |
          cargo run --bin migrate_atlas -- --check assets/images

      - name: Run animation target measurement
        shell: pwsh
        run: |
          ./scripts/ci/run_animation_targets.ps1 -OutputDirectory artifacts

      - name: Run isolated plugin telemetry test
        shell: pwsh
        run: |
          cargo test --test plugins isolated_plugin_telemetry_pipeline

      - name: Run perf suite
        shell: pwsh
        run: |
          $label = "${{ env.PERF_SUITE_LABEL }}"
          python scripts/run_perf_suite.py `
            --label $label `
            --runs 3 `
            --count 10000 `
            --steps 240 `
            --warmup 16 `
            --dt 0.016666667 `
            --bench-profile release `
            --bench-test animation_targets_measure `
            --bench-test-args "--ignored --nocapture"
      - name: Run GPU baseline check
        shell: pwsh
        run: |
          ./scripts/ci/run_gpu_baseline.ps1 -Output perf/gpu_baseline_ci.json -Baseline perf/gpu_baseline.json

      - name: Upload target report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: animation-targets
          path: artifacts/animation_targets_report.json

      - name: Upload perf suite artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-suite
          path: perf/${{ env.PERF_SUITE_LABEL }}*
      - name: Upload GPU baseline
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-baseline
          path: perf/gpu_baseline_ci.json
